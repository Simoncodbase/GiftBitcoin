<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Final Card with Bitcoin Addresses</title>
    <!-- Include necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --card-width: 30vw;
            --card-height: 40vw;
            --image-height: 30vw;
            --text-area-height: 10vw;
            --side-margin: 20px; /* Adjusted side margin */
        }

        #main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        #payment-successful {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        #payment-successful h2 {
            margin: 0;
            margin-right: 10px;
        }

        #green-tick {
            width: 24px;
            height: 24px;
            background-color: green;
            border-radius: 50%;
            position: relative;
        }

        #green-tick::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        #important-message {
            text-align: center;
            margin-bottom: 20px;
        }

        #pdf-button {
            margin-bottom: 20px;
        }

        #printable-content {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: var(--side-margin); /* Ensures consistent gap */
        }

        #card-container {
            width: var(--card-width);
            height: var(--card-height);
            position: relative;
            border: 1px solid #000;
            background-color: white;
            flex-shrink: 0;
        }

        #card-image {
            width: 100%;
            height: var(--image-height);
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }

        #text-area {
            position: absolute;
            top: var(--image-height);
            left: 0;
            width: 100%;
            height: var(--text-area-height);
            background-color: transparent;
        }

        .text-field {
            position: absolute;
        }

        #bitcoin-addresses-container {
            width: var(--card-width);
        }

        .key-container {
            margin-bottom: 20px;
            word-wrap: break-word;
        }

        .qr-code {
            text-align: center;
            margin-top: 10px;
        }

        @media print {
            :root {
                --card-width: 45%;
            }

            @page {
                margin: 0;
                size: auto;
            }

            body {
                margin: 0;
            }

            #main-container, #printable-content {
                width: 100%;
                margin: 0 auto;
            }

            body * {
                visibility: hidden;
            }

            #printable-content, #printable-content * {
                visibility: visible;
            }

            #pdf-button, #payment-successful, #important-message {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="payment-successful">
            <h2>Payment Successful</h2>
            <div id="green-tick"></div>
        </div>
        <div id="important-message">
            <p>Important: Save or print your card now in a secure way! You will later not be able to retrieve your keys!</p>
        </div>
        <button id="pdf-button">Click for PDF</button>
        <div id="printable-content">
            <div id="card-container">
                <img id="card-image" src="" alt="Card Background">
                <div id="text-area"></div>
            </div>
            <div id="bitcoin-addresses-container"></div>
        </div>
    </div>
    <script>
        function loadCard() {
            const cardHTML = localStorage.getItem('cardHTML');
            if (cardHTML) {
                const cardContainer = document.getElementById('card-container');
                const cardImage = document.getElementById('card-image');
                const textArea = document.getElementById('text-area');

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML;

                const backgroundImage = tempDiv.querySelector('#background');
                if (backgroundImage) {
                    cardImage.src = backgroundImage.src;
                }

                const textFields = tempDiv.querySelectorAll('.text-field');
                textArea.innerHTML = '';
                textFields.forEach(function (field) {
                    textArea.appendChild(field);
                });
            } else {
                console.error('No card data found in localStorage');
            }
        }

        function encodeBase58(buffer) {
            const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let carry, digits = [0];
            for (let i = 0; i < buffer.length; i++) {
                carry = buffer[i];
                for (let j = 0; j < digits.length; ++j) {
                    carry += digits[j] << 8;
                    digits[j] = carry % 58;
                    carry = (carry / 58) | 0;
                }
                while (carry) {
                    digits.push(carry % 58);
                    carry = (carry / 58) | 0;
                }
            }
            let string = '';
            for (let k = 0; buffer[k] === 0 && k < buffer.length - 1; k++) {
                string += ALPHABET[0];
            }
            for (let q = digits.length - 1; q >= 0; q--) {
                string += ALPHABET[digits[q]];
            }
            return string;
        }

        function generateBitcoinAddresses() {
            try {
                var EC = elliptic.ec;
                var ec = new EC('secp256k1');
                var keyPair = ec.genKeyPair();
                var privateKeyHex = keyPair.getPrivate('hex');
                var publicKey = keyPair.getPublic(true, 'hex');

                var publicKeyBuffer = CryptoJS.enc.Hex.parse(publicKey);
                var hash = CryptoJS.SHA256(publicKeyBuffer);
                var ripemd160 = CryptoJS.RIPEMD160(hash);
                var publicKeyHash = ripemd160.toString();

                var networkByte = '00' + publicKeyHash;

                var checksumFull = CryptoJS.SHA256(CryptoJS.SHA256(CryptoJS.enc.Hex.parse(networkByte))).toString();
                var checksum = checksumFull.substr(0, 8);

                var addressHex = networkByte + checksum;
                var addressWordArray = CryptoJS.enc.Hex.parse(addressHex);
                var addressUint8Array = new Uint8Array(addressWordArray.sigBytes);
                for (var i = 0; i < addressWordArray.sigBytes; i++) {
                    addressUint8Array[i] = (addressWordArray.words[Math.floor(i / 4)] >>> (24 - (i % 4) * 8)) & 0xFF;
                }
                var address = encodeBase58(addressUint8Array);

                displayBitcoinAddresses(privateKeyHex, address);
            } catch (error) {
                console.error('Error generating Bitcoin addresses:', error);
                alert('Error generating Bitcoin addresses: ' + error.message);
            }
        }

        function displayBitcoinAddresses(privateKey, address) {
            var container = document.getElementById('bitcoin-addresses-container');
            container.innerHTML = '';

            var publicContainer = document.createElement('div');
            publicContainer.classList.add('key-container');

            var publicKeyLabel = document.createElement('h3');
            publicKeyLabel.textContent = 'Public Address:';
            publicContainer.appendChild(publicKeyLabel);

            var publicKeyText = document.createElement('p');
            publicKeyText.textContent = address;
            publicContainer.appendChild(publicKeyText);

            var publicKeyQRContainer = document.createElement('div');
            publicKeyQRContainer.classList.add('qr-code');
            publicContainer.appendChild(publicKeyQRContainer);
            new QRCode(publicKeyQRContainer, {
                text: address,
                width: 128,
                height: 128,
            });

            container.appendChild(publicContainer);

            var privateContainer = document.createElement('div');
            privateContainer.classList.add('key-container');

            var privateKeyLabel = document.createElement('h3');
            privateKeyLabel.textContent = 'Private Key:';
            privateContainer.appendChild(privateKeyLabel);

            var privateKeyText = document.createElement('p');
            privateKeyText.textContent = privateKey;
            privateContainer.appendChild(privateKeyText);

            var privateKeyQRContainer = document.createElement('div');
            privateKeyQRContainer.classList.add('qr-code');
            privateContainer.appendChild(privateKeyQRContainer);
            new QRCode(privateKeyQRContainer, {
                text: privateKey,
                width: 128,
                height: 128,
            });

            container.appendChild(privateContainer);
        }

        document.getElementById('pdf-button').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth() - margin * 2;
            const pageHeight = doc.internal.pageSize.getHeight() - margin * 2;

            const cardContainer = document.getElementById('card-container');
            const keysContainer = document.getElementById('bitcoin-addresses-container');

            html2canvas(cardContainer).then((canvasCard) => {
                const imgCard = canvasCard.toDataURL('image/png');
                const imgWidth = pageWidth / 2 - 10;
                const imgHeight = (canvasCard.height * imgWidth) / canvasCard.width;

                html2canvas(keysContainer).then((canvasKeys) => {
                    const imgKeys = canvasKeys.toDataURL('image/png');
                    const imgHeightKeys = (canvasKeys.height * imgWidth) / canvasKeys.width;

                    const y = (pageHeight - imgHeight - imgHeightKeys) / 2;

                    doc.addImage(imgCard, 'PNG', margin, y, imgWidth, imgHeight);
                    doc.addImage(imgKeys, 'PNG', margin + imgWidth + 20, y, imgWidth, imgHeightKeys);

                    doc.save('card_and_keys.pdf');
                });
            });
        });

        window.onload = function () {
            loadCard();
            generateBitcoinAddresses();
        };
    </script>
</body>
</html>
