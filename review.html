<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Final Card with Bitcoin Addresses</title>
    <!-- Include necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --card-width: 45%;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        #pdf-button {
            margin: 20px 0;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #printable-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        #card-container {
            position: relative;
            width: var(--card-width);
            border: 1px solid #000;
            background-color: white;
        }

        #card-image {
            width: 100%;
            height: auto;
            display: block;
        }

        #text-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .text-field {
            position: absolute;
            font-size: 16px;
            color: black;
        }

        #bitcoin-addresses-container {
            width: var(--card-width);
        }

        .key-container {
            margin-bottom: 20px;
        }

        .qr-code {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <button id="pdf-button">Click for PDF</button>

        <div id="printable-content">
            <div id="card-container">
                <img id="card-image" src="" alt="Card Background">
                <div id="text-area"></div>
            </div>

            <div id="bitcoin-addresses-container"></div>
        </div>
    </div>

    <script>
        function loadCard() {
            const cardHTML = localStorage.getItem('cardHTML');
            if (cardHTML) {
                const cardContainer = document.getElementById('card-container');
                const cardImage = document.getElementById('card-image');
                const textArea = document.getElementById('text-area');

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML;

                const backgroundImage = tempDiv.querySelector('#background');
                if (backgroundImage) {
                    cardImage.src = backgroundImage.src;
                }

                const textFields = tempDiv.querySelectorAll('.text-field');
                textArea.innerHTML = '';

                textFields.forEach((field) => {
                    textArea.appendChild(field);
                });
            } else {
                console.error('No card data found in localStorage');
            }
        }

        function generateBitcoinAddresses() {
            const EC = elliptic.ec;
            const ec = new EC('secp256k1');
            const keyPair = ec.genKeyPair();
            const privateKeyHex = keyPair.getPrivate('hex');

            const privateKeyWIF = wifEncode(privateKeyHex);
            const publicKey = keyPair.getPublic(true, 'hex');

            const publicKeyHash = CryptoJS.RIPEMD160(CryptoJS.SHA256(CryptoJS.enc.Hex.parse(publicKey))).toString();
            const networkByte = '00' + publicKeyHash;
            const checksum = CryptoJS.SHA256(CryptoJS.SHA256(CryptoJS.enc.Hex.parse(networkByte))).toString().substr(0, 8);
            const address = encodeBase58(CryptoJS.enc.Hex.parse(networkByte + checksum));

            localStorage.setItem('privateKeyWIF', privateKeyWIF);
            localStorage.setItem('address', address);

            displayBitcoinAddresses(privateKeyWIF, address);
        }

        function displayBitcoinAddresses(privateKeyWIF, address) {
            const container = document.getElementById('bitcoin-addresses-container');
            container.innerHTML = '';

            const publicContainer = document.createElement('div');
            publicContainer.classList.add('key-container');
            publicContainer.innerHTML = `<h3>Public Address:</h3><p>${address}</p>`;
            const publicQRCode = document.createElement('div');
            publicQRCode.classList.add('qr-code');
            publicContainer.appendChild(publicQRCode);
            new QRCode(publicQRCode, { text: address, width: 128, height: 128 });
            container.appendChild(publicContainer);

            const privateContainer = document.createElement('div');
            privateContainer.classList.add('key-container');
            privateContainer.innerHTML = `<h3>Private Key (WIF):</h3><p>${privateKeyWIF}</p>`;
            const privateQRCode = document.createElement('div');
            privateQRCode.classList.add('qr-code');
            privateContainer.appendChild(privateQRCode);
            new QRCode(privateQRCode, { text: privateKeyWIF, width: 128, height: 128 });
            container.appendChild(privateContainer);
        }

        function encodeBase58(buffer) {
            const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let carry, digits = [0];
            for (let i = 0; i < buffer.length; i++) {
                carry = buffer[i];
                for (let j = 0; j < digits.length; ++j) {
                    carry += digits[j] << 8;
                    digits[j] = carry % 58;
                    carry = (carry / 58) | 0;
                }
                while (carry) {
                    digits.push(carry % 58);
                    carry = (carry / 58) | 0;
                }
            }
            return digits.reverse().map((d) => ALPHABET[d]).join('');
        }

        function wifEncode(privateKeyHex) {
            const step1 = '80' + privateKeyHex;
            const step2 = CryptoJS.SHA256(CryptoJS.enc.Hex.parse(step1));
            const checksum = CryptoJS.SHA256(step2).toString().substr(0, 8);
            return encodeBase58(CryptoJS.enc.Hex.parse(step1 + checksum));
        }

        document.getElementById('pdf-button').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const cardContainer = document.getElementById('card-container');
            const clone = cardContainer.cloneNode(true);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'fixed';
            tempContainer.style.top = '-10000px';
            tempContainer.style.left = '-10000px';
            document.body.appendChild(tempContainer);
            tempContainer.appendChild(clone);

            html2canvas(clone, { scale: 2, useCORS: true }).then((canvas) => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                doc.save('final_card.pdf');
                document.body.removeChild(tempContainer);
            });
        });

        window.onload = function () {
            loadCard();
            generateBitcoinAddresses();
        };
    </script>
</body>
</html>
