<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Review Your Card &amp; Payment</title>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    :root {
        --card-width: 30vw;
        --card-height: 40vw;
        --image-height: 30vw;
        --text-area-height: 10vw;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
    }

    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    @media (min-width: 1024px) {
        .main-container {
            flex-direction: row;
            align-items: flex-start;
        }

        .printable-container {
            flex: 1;
        }

        .controls-container {
            width: 750px;
            margin-left: 20px;
        }
    }

    .printable-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: flex-start;
        flex-wrap: nowrap;
        gap: 20px;
    }

    #card-container {
        width: var(--card-width);
        height: var(--card-height);
        position: relative;
        border: 1px solid #000;
        background-color: white;
        flex-shrink: 0;
    }

    #background {
        width: 100%;
        height: var(--image-height);
        position: absolute;
        top: 0;
        left: 0;
        display: block;
    }

    #text-area {
        position: absolute;
        top: var(--image-height);
        left: 0;
        width: 100%;
        height: var(--text-area-height);
        background-color: transparent;
    }

    .controls-container {
        margin-top: 20px;
    }

    #payment-form {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #payment-element {
        margin-bottom: 24px;
    }

    #payment-message {
        color: rgb(105, 115, 134);
        font-size: 16px;
        line-height: 20px;
        padding-top: 12px;
        text-align: center;
    }

    button {
        background: #F59E0B;
        color: #000000;
        font-family: Arial, sans-serif;
        border-radius: 8px;
        border: 0;
        padding: 12px 16px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: inline-block;
        transition: all 0.2s ease;
    }
    button:hover {
        background: #FBBF24;
    }

    @media (max-width: 768px) {
        #card-container,
        #image-container {
            width: 80vw;
        }

        #card-container {
            height: calc(80vw * 4 / 3);
        }

        .printable-container {
            flex-wrap: wrap;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        #card-container,
        #image-container {
            width: 90vw;
        }

        #card-container {
            height: calc(90vw * 4 / 3);
        }

        .printable-container {
            flex-wrap: wrap;
            justify-content: center;
        }
    }
</style>
</head>
<body>
<div class="main-container">
<div class="printable-container">
<div id="card-container"></div>
<div id="image-container">
<img alt="Example Key" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/wcAAgEB/wFB/OQAAAAASUVORK5CYII=" />
</div>
</div>
<div class="controls-container">
    <form id="payment-options">
        <h2>Payment Options</h2>
        <label for="currency-select">Currency:</label>
        <select id="currency-select" name="currency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="CHF">CHF</option>
        </select>
        <br><br>
        <label>Enter Amount:</label>
        <input type="number" id="custom-amount" name="custom-amount" min="1" step="1">
        <br><br>
        <p id="credit-info">Based on your amount of X, the user will be credited X-10 CURRENCY in BTC within 24 hours based on the prevailing BTC/CURRENCY rate at the time of the execution.</p>
        <button id="proceed-to-payment" type="button">Proceed to Payment</button>
    </form>
    <form id="payment-form" style="display: none;">
        <h2>Payment Details</h2>
        <div id="payment-element"></div>
        <button id="submit" type="submit">
            <span id="button-text">Pay now</span>
        </button>
        <div id="payment-message"></div>
    </form>
</div>
</div>
<script>
    const stripe = Stripe('pk_test_51Q9TrZEAbBnxrSl5cASxdzrObnYUOgytR7iS55Fn1EtwGIguhqmqRlObWaj5n9MCVrRzKRcN1MwOQrpm49S9d5PY00Fp8qHAFt');
    let elements;

    document.getElementById('custom-amount').addEventListener('input', updateCreditInfo);
    document.getElementById('currency-select').addEventListener('change', updateCreditInfo);

    function updateCreditInfo() {
        const amount = parseFloat(document.getElementById('custom-amount').value || 0);
        const currency = document.getElementById('currency-select').value;
        const creditedAmount = amount - 10;

        document.getElementById('credit-info').textContent = `Based on your amount of ${amount} ${currency}, the user will be credited ${creditedAmount > 0 ? creditedAmount : 0} ${currency} in BTC within 24 hours based on the prevailing BTC/${currency} rate at the time of the execution.`;
    }

    document.getElementById('proceed-to-payment').addEventListener('click', async function () {
        const currency = document.getElementById('currency-select').value;
        const amount = parseFloat(document.getElementById('custom-amount').value || 0) * 100; // Convert to smallest currency unit

        if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid amount.');
            return;
        }

        document.getElementById('payment-options').querySelectorAll('input, select, button').forEach(elem => elem.disabled = true);
        document.getElementById('payment-form').style.display = 'block';

        const response = await fetch('/.netlify/functions/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, currency })
        });

        if (!response.ok) {
            alert('Failed to initialize payment.');
            return;
        }

        const { clientSecret } = await response.json();

        elements = stripe.elements({
            clientSecret,
            appearance: { theme: 'stripe' }
        });

        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
    });

    document.getElementById('payment-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const { error } = await stripe.confirmPayment({ elements });
        if (error) {
            document.getElementById('payment-message').textContent = error.message;
        } else {
            window.location.href = '/payment-success.html';
        }
    });
</script>
</body>
</html>
